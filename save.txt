<?php

require_once(realpath(__DIR__ . '/base/FactoryBase.php'));
require_once(realpath(__DIR__ . '/../models/Product.php'));
require_once(realpath(__DIR__ . '/../models/CartProduct.php'));

class ProductFactory extends FactoryBase
{
    public function getAllProducts(){
        
        $products = array();

        $db = $this->dbConnect();
        $stmt = $db->prepare('SELECT * FROM tp1_produits');
        $stmt->execute();

        while($row = $stmt->fetch()){
            $products[] = new Product($row);
        }

        $stmt->closecursor();

        return $products;
    }

    public function buyProduct($product_id, $quantity){
        $db = $this->dbConnect();
        $stmt = $db->prepare('UPDATE tp1_panier SET tp1_panier.Quantite = tp1_panier.Quantite + :quantity WHERE tp1_panier.Id = :id');
        $stmt->bindParam(":quantity", $quantity);
        $stmt->bindParam(":id", $product_id);
        $stmt->execute();
    }

    public function getCart(){
        
        $products = array();

        $db = $this->dbConnect();
        $stmt = $db->prepare('SELECT Panier.Id, Produit.Nom, Produit.Quantite, Produit.Unite, Produit.Prix, Produit.Image, Panier.Quantite 
                            from tp1_panier as Panier 
                            inner join tp1_produits as Produit on Panier.ProduitId = Produit.Id
                            where Panier.Quantite > 0');

        $stmt->execute();

        while($row = $stmt->fetch()){
            $products[] = new CartProduct($row);
        }

        $stmt->closecursor();

        return $products;
    }

    public function deleteItem($item_id){
        $db = $this->dbConnect();
        $stmt = $db->prepare('UPDATE tp1_panier SET tp1_panier.Quantite = 0 WHERE tp1_panier.Id = :id'); 
        $stmt->bindParam(":id", $item_id);
        $stmt->execute();
    }
}
